# CausalImpact

## 패키지 소개 요약

### CausalImpact는 무엇일까?

- 시계열 데이터에서 의도적인 개입으로 인한 인과 효과를 추정하기 위한 방법론이다.
- "광고 캠페인을 적용했을 때 일별 클릭수는 얼마나 증가했을까?" 같은 질문은 실험이 불가능한 상황에서 답변하는 것이 매우 어렵다.

### 어떻게 동작할까?

- 결과 변수에 해당하는 시계열과 (예. 클릭수) 통제 변수에 해당하는 시계열 (예. 개입이 적용되지 않은 영역의 클릭수 또는 다른 사이트의 클릭수)가 주어졌을 때, Bayesian Structural time-series model 을 구축한다.
- 학습한 시계열 모형을 통해 counterfactual 을 예측하다. 다시 말해, 만약 특정 시점에 개입이 일어나지 않았다면 그 이후에 지표가 어떻게 되었을지를 예측한다.

### 모형이 어떤 가정을 하고 있을까?

1. 통제 변수(Control) 역할을 하는 시계열은 개입의 영향을 받지 않아야 한다.
2. 개입 이전 시점의 공변량과 결과 변수의 관계가 개입 이후에도 유지되어야 한다.
    - 이 가정을 완화시키고 싶을 경우 dynamic regression 을 추가로 적용할 수 있다.
3. 모형에 Prior가 포함되어 있다는 사실을 명심해야 한다.
    - CausalImpact가 기본적으로 시계열 학습에 사용하는 모형은 Local Level 을 위해 Gaussian random walk 를 사용하는데, 이 때 random walk의 표준 편차에 Prior가 설정되어 있다.

### 모형의 가정을 만족하는지 어떻게 확인할 수 있을까?

다음과 같은 방법으로 시작해보자.

1. 왜 모형에 포함된 공변량들이 개입의 영향을 받지 않았는지 고민해야 한다.
    - 모든 공변량을 그래프로 그려서 시각적으로 확인해 볼 필요도 있다.
2. 개입 이전 시점까지의 시계열을 얼마나 잘 예측하는지 확인해야 한다. 임의의 시점에 가상의 개입이 이루어졌다고 가정하고 모형을 학습하면 어떤 결론이 나오는지 확인해본다. 이 때 counterfactual 예측과 실제값이 비슷해서 통계적으로 유의미하지 않은 결론이 나와야 한다.
3. 모형의 학습 결과를 공유할 때는 가정한 내용들과 모형의 파라미터를 포함하여 공유한다. 다른 사람들과 함께 유효한 가정인지, 적절한 파라미터를 사용한 것인지 논의하는 것이 좋다.

## 논문 요약

- 신제품 출시나 광고 캠페인의 시작/종료 등 특정 시점에 발생한 마케팅 이벤트가 목표로 하는 지표에 미친 영향을 측정하고자 한다.
    - 지금은 목표로 하는 결과 변수가 시계열이기 때문에, 우리가 알고자 하는 인과 효과는 관측된 시계열과 개입이 발생하지 않았을 때의 시계열의 차이가 된다.
- 개입이 발생하지 않았을 경우를 예측하기 위해 사용할 수 있는 접근법으로 여러 예측 변수를 모아 하나의 가상 대조군 데이터를 추정하는 방식이 있다.
    - 가상의 대조군을 만들기 위해서는 크게 세가지 정보가 필요하다.
        - (1) 결과 변수 시계열 (개입 이전)
        - (2) 결과 변수를 예측하는데 도움이 되는 다른 시계열 (개입 이전)
        - (3) 적절한 모형 파라미터를 위한 Prior (베이지안 모형을 사용할 경우)
    - 위 세 가지 정보를 모아 state-space 시계열 모형을 구성한다.
        - 상태 컴포넌트의 구성 요소들은 같은 시점의 결과 변수를 예측하기 위한 선형 회귀 모형에 사용된다.
- 마케팅 영역의 인과 추론과 관련된 작업들
    - 마케팅 데이터는 이상적인 randomised design 이 어려운 경우가 많이 발생한다.
        - 신호와 소음의 비율을 비교했을 때 신호의 비율이 낮은 편이다.
        - 여러 계절성이 나타날 수 있다.
        - 관측되지 않은 변수들과 변수간의 상호작용으로 인해 교란효과가 발생할 수 있다.
    - 이런 상황에서 인과 효과를 추정하기 위해 일반적으로 사용하는 방식은 바로 Difference-in-differences (DD) 이다.
        - 실험군과 통제군에 대해서 개입 전후를 설명하는 선형 모형을 구성한다.
        - 실험군의 개입 전후 차이를 비교하고, 통제군의 개입 전후 차이를 비교한다. 그리고 실험군과 통제군의 차이를 비교한다.
    - DD 방법론에는 몇 가지 한계점이 있다.
        - (1) DD는 iid 가정을 바탕으로 하는 정적인 회귀 모형을 사용하는데, 데이터는 시간에 따라 변하는 특성을 가지고 있다.
        - (2) 대부분의 DD 분석은 개입 이전과 이후로만 나누어서 분석한다. 시간에 따라 효과가 변하는 경우에는 인과 효과를 정확하게 추정할 수 없다.
        - (3) 시계열을 바탕으로 DD 분석을 할 때 예측 변수로 가상의 대조군을 구성하는 방식을 제한하는 경우가 있다. 이러한 방식을 최대한 피하고자 한다.
            - 예측 변수를 선택할 때 외부의 정보를 참고하지 않고, 결과 변수를 얼마나 잘 설명하는지 기준으로만 선택하려고 한다.
    - DD 방법론의 한계점을 해결하기 위해, state-space 모형에 유연한 회귀 모형 컴포넌트를 결합하여 관측 결과가 시간에 따라 어떻게 변했는지 설명했다.
- 베이지안 구조적 시계열 모형 (Bayesian structural time-series models)
    - 구조적 시계열 모형은 시계열 데이터를 위한 상태-공간 모형이다.
        - 현재 상태를 바탕으로 관측 결과를 설명하는 식(Observation equation)과 현재 상태를 통해 다음 상태를 설명하는 식(State equation)으로 구성되어 있다.
        - 구조적 시계열 모형은 유연하고 모듈화가 가능하기 때문에 매우 실용적이다. ARIMA 모형을 포함하여 다양한 계절성과 특정 공휴일 또는 이벤트로 인한 효과까지 모형으로 표현할 수 있다.
    - 상태 컴포넌트
        - (1) 트렌드
            - 기본적으로 사용하는 `Local Linear Trend` 컴포넌트는 drift term을 포함하는 랜덤 워크로 구성되어 있다. drift term에 해당하는 부분이 트렌드의 기울기를 표현하게 된다.
            - `Local Linear Trend` 는 단기 트렌드 예측에 유리하도록 구성되어 있다.
            - 베이지안 구조적 시계열 모형을 구현한 bsts 라이브러리에서는 랜덤워크의 기울기 부분만 정상성을 만족하는 AR(1)으로 대체하여 장기 트렌드 예측에 사용할 수 있는 별도의 컴포넌트를 제공한다. bsts 에서는 해당 컴포넌트를 `Semilocal Linear Trend` 라고 부른다.
        - (2) 계절성
            - S개의 시즌 효과를 모두 합쳤을 때 0 이 되도록 모형을 학습한다.
            - `S=4` 로 설정하여 사계절의 효과를 확인할 경우, 겨울의 효과는 `-1 x (봄 + 여름 + 가을)` 이 된다.
            - 시즌의 길이는 임의로 조정할 수 있다. 일별 데이터에서 요일 효과를 알고자 한다면 `S=7` 로 두면 된다.
        - (3) 동일한 시점의 공변량과 회귀모형 계수
            - 보통은 시간에 따라 변수들의 계수가 변하지 않는 static regression을 사용한다. 하지만 시간에 따라 변수간의 관계가 변하는 경우 dynamic regression을 적용할 수 있다.
            - spike-and-slab prior를 사용해 공변량 중에서 예측에 포함되어야 하는 의미있는 변수만 모형에 반영된다. 이를 통해 오버피팅을 피하게 되는 효과도 있다.
            - 모든 공변량은 예측하려는 시계열과 같은 시간대의 정보를 가진다. 현재 모형에서는 시계열간의 시차를 고려하지 않는다.
    - 추론하기
        - (1) MCMC를 통해 개입 이전의 관측 데이터를 바탕으로 모형 파라미터와 상태 벡터를 시뮬레이션한다.
        - (2) 개입 이전의 목표 시계열과 전체 기간의 공변량을 반영하여 개입이 없었을 경우의 시계열 분포를 시뮬레이션한다.
        - (3) 2번의 posterior 샘플링 결과를 통해 시점별 인과 효과와 누적 인과 효과의 사후 분포를 구한다.
    - 효과 계산하기
        - 각 시점의 실제 시계열과 개입이 없을 경우를 가정해 예측한 가상의 대조군 시계열의 차이를 구하면 시점별(pointwise) 효과를 구할 수 있다.
        - 개입 이후의 누적 효과를 계산할 수도 있는데, 단위 시간동안 계산하는 지표의 경우 누적 효과가 해석에 도움이 될 수 있다.
            - 검색수, 회원가입 수, 매출, 설치 또는 가입 수
        - 반면 특정 시점에서만 의미 있는 수치들은 오히려 누적 효과를 통해 해석하기 어렵다.
            - 특정 시점의 고객수, 구독자수
